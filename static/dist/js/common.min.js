var ctrlGeolocate,isMobile=/Mobi/.test(navigator.userAgent),MARKER_TARGET=new mapboxgl.Marker({color:"#207FD0"}),MARKER_START=new mapboxgl.Marker({color:"#6BB03E"}),MARKER_END=new mapboxgl.Marker({color:"#FF7866"}),SKIP_TO_DIRECTIONS=!1,SETTINGS=[];SETTINGS.coordinate_format="dms";var currentHotspots,currentTrailViewMarker=null,currTrailViewGeo=null,isMouseOnTrailViewLayer=!1,trailViewData=null,isMobileView=!1,isTrailViewEnabled=!1,fullElement="map",isMap3D=!1,updateMarkerRotationInterval=null,updateNavArrowsInterval=null;function createTrailViewMapLayer(e){if(!MAP.getSource("dots")){let a={type:"geojson",data:{type:"FeatureCollection",features:[]}},t=[];for(let a=0;a<e.length;a++){let r={type:"Feature",properties:{imageID:e[a].id},geometry:{type:"Point",coordinates:[e[a].longitude,e[a].latitude]}};t.push(r)}a.data.features=t,MAP.addSource("dots",a)}if(MAP.addLayer({id:"dots",type:"circle",source:"dots",paint:{"circle-radius":10,"circle-color":"#00a108","circle-pitch-alignment":"viewport","circle-pitch-scale":"map"},layout:{"circle-sort-key":100}}),MAP.setPaintProperty("dots","circle-radius",["interpolate",["exponential",.5],["zoom"],13,3,16,5,17,7,20,10]),MAP.setPaintProperty("dots","circle-opacity",["interpolate",["exponential",.5],["zoom"],13,.05,15,.1,17,.25,20,1]),!currentTrailViewMarker){const e=document.createElement("div");e.classList.add("marker-current-wrapper");const a=document.createElement("div");a.classList.add("marker-current");const t=document.createElement("div");t.classList.add("marker-viewer"),e.appendChild(a),e.appendChild(t),currentTrailViewMarker=new mapboxgl.Marker(e).setLngLat([-81.682665,41.4097766]).addTo(MAP).setRotationAlignment("map").setPitchAlignment("map"),null!=currTrailViewGeo&&currentTrailViewMarker.setLngLat([currTrailViewGeo.longitude,currTrailViewGeo.latitude])}}function updateTrailView(){$("#trailview_checkbox").is(":checked")?(MAP.getLayer("dots")?MAP.addLayer("dots"):createTrailViewMapLayer(trailViewData),TRAILVIEWER||createTrailViewer(),isTrailViewEnabled=!0):(MAP.getLayer("dots")&&MAP.removeLayer("dots"),currentTrailViewMarker&&(currentTrailViewMarker.remove(),currentTrailViewMarker=null),clearInterval(updateMarkerRotationInterval),clearInterval(updateNavArrowsInterval),$("new_nav").remove(),destroyTrailViewer(),isTrailViewEnabled=!1)}function createTrailViewer(){TRAILVIEWER||(TRAILVIEWER=new TrailViewer({useURLHashing:!1,onGeoChangeFunc:onGeoChange,onInitDoneFunc:onInitDone,onArrowsAddedFunc:populateArrows,navArrowMinAngle:-25,navArrowMaxAngle:-20},null,trailViewData,MAP.getCenter().lat,MAP.getCenter().lng),$("#viewer_container").stop().fadeIn(500))}function destroyTrailViewer(){TRAILVIEWER&&(TRAILVIEWER.destroy(),TRAILVIEWER=null),$("#viewer_container").stop().fadeOut(500)}function clamp(e,a,t){return Math.min(Math.max(e,a),t)}function resizeElements(){TRAILVIEWER&&TRAILVIEWER._panViewer&&TRAILVIEWER._panViewer.resize(),MAP&&MAP.resize()}function updateContainers(){isTrailViewEnabled?($("#map_fullscreen_btn").show(),"map"==fullElement?(TRAILVIEWER._panViewer.setHfov(120,500),$("#sidebar").show(),$("#map_container").show(),$("#map_container").removeClass().addClass("full-container"),isMobileView?$("#viewer_container").hide():($("#viewer_container").show().removeClass().addClass("small-container"),populateArrows(currentHotspots))):"viewer"==fullElement?(isMobileView?(TRAILVIEWER._panViewer.setHfov(90,500),$("#sidebar").hide(),$("#map_container").hide()):(TRAILVIEWER._panViewer.setHfov(120,500),$("#map_container").show().removeClass().addClass("small-container")),$("#viewer_container").show().removeClass().addClass("full-container"),populateArrows(currentHotspots)):(TRAILVIEWER._panViewer.setHfov(120,500),$("#sidebar").show(),$("#map_container").show().removeClass().addClass("bottom-container"),$("#viewer_container").show().removeClass().addClass("top-container"),populateArrows(currentHotspots))):($("#map_fullscreen_btn").hide(),$("#sidebar").show(),$("#map_container").show().removeClass().addClass("full-container"),$("#viewer_container").hide()),resizeElements()}function onWindowResize(){!isMobileView&&window.innerWidth<1024?(isMobileView=!0,fullElement=null,updateContainers()):isMobileView&&window.innerWidth>=1024&&(isMobileView=!1,fullElement="map",updateContainers())}function initTrailView(){onWindowResize(),$("#trailview_checkbox").on("change",()=>{updateTrailView(),isTrailViewEnabled&&(fullElement=1==isMobileView?null:"map"),updateContainers(),$("#sidebar").show()}),$("#map_fullscreen_btn").on("click",()=>{fullElement=isMobileView?"map"==fullElement?null:"map":"map"==fullElement?"viewer":"map",updateContainers()}),$("#viewer_fullscreen_btn").on("click",()=>{fullElement=isMobileView?"viewer"==fullElement?null:"viewer":"viewer"==fullElement?"map":"viewer",updateContainers()}),$("#3d_btn").on("click",()=>{if(isMap3D){changeBasemap("map"),MAP.stop();let e=MAP.getCenter();currentTrailViewMarker&&(e=currentTrailViewMarker.getLngLat()),setTimeout(()=>{MAP.easeTo({center:e,pitch:0,duration:500,bearing:0})},500),isMap3D=!1}else{MAP.setMaxPitch(60),MAP.setMinPitch(0),changeBasemap("photo");let e=MAP.getCenter();currentTrailViewMarker&&(e=currentTrailViewMarker.getLngLat());let a=MAP.getZoom();a=clamp(a,16,19),setTimeout(()=>{MAP.easeTo({center:e,pitch:60,bearing:MAP.getBearing()+179,zoom:a,easing:e=>1-Math.cos(e*Math.PI/2),duration:3e3}).once("moveend",()=>{MAP.easeTo({bearing:MAP.getBearing()+179,duration:7e3,easing:e=>Math.sin(e*Math.PI/2)})})},500),isMap3D=!0}}),MAP.on("click",e=>{if(TRAILVIEWER){let a=TRAILVIEWER.getNearestImageId(e.lngLat.lat,e.lngLat.lng,10);null!=a&&(isMobileView&&"map"==fullElement&&(fullElement=null,updateContainers()),TRAILVIEWER.goToImageID(a))}}),MAP.on("mouseenter","dots",()=>{isMouseOnTrailViewLayer=!0,MAP.getCanvas().style.cursor="pointer"}),MAP.on("mouseleave","dots",()=>{isMouseOnTrailViewLayer=!1,MAP.getCanvas().style.cursor="grab"}),MAP.on("mousedown",()=>{isMouseOnTrailViewLayer||(MAP.getCanvas().style.cursor="grabbing")}),MAP.on("mouseup",()=>{MAP.getCanvas().style.cursor=isMouseOnTrailViewLayer?"pointer":"grab"})}function fetchTrailViewData(){$.getJSON("https://trailview.cmparks.net/api/images.php",{type:"standard"},(function(e,a,t){trailViewData=e.imagesStandard,initTrailView()}))}function initMap(e){var a;switch(e.base||"map"){case"photo":a=STYLE_LAYER_CM_SAT;break;case"map":default:a=STYLE_LAYER_CM_MAP}MAP=new mapboxgl.Map({container:"map_canvas",style:a,clickTolerance:10,center:START_CENTER,zoom:START_ZOOM,maxPitch:60,minPitch:0,preserveDrawingBuffer:!1});var t=new mapboxgl.NavigationControl;MAP.addControl(t,"bottom-right"),ctrlGeolocate=new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:0!=e.trackUserLocation}),MAP.addControl(ctrlGeolocate,"bottom-right");var r=new mapboxgl.ScaleControl({maxWidth:80,unit:"imperial"});if(MAP.addControl(r,"bottom-left"),e.lat&&e.lng&&e.zoom){var n=parseFloat(e.lat),i=parseFloat(e.lng),o=parseInt(e.zoom);MAP.setCenter([i,n]),MAP.setZoom(o),e.drop_marker&&(MAP.addLayer(MARKER_TARGET),placeMarker(MARKER_TARGET,i,n))}else MAP.fitBounds(MAX_BOUNDS);$.event.trigger({type:"mapInitialized"})}function updateMarkerRotation(){if(TRAILVIEWER&&TRAILVIEWER._panViewer&&currentTrailViewMarker){let e=TRAILVIEWER.getBearing();currentTrailViewMarker.setRotation((e+225)%360)}}function onInitDone(e){e._panViewer.resize(),updateMarkerRotationInterval=setInterval(updateMarkerRotation,16),updateNavArrowsInterval=setInterval(updateNavArrows,16)}function updateNavArrows(){if(TRAILVIEWER&&TRAILVIEWER._panViewer){$(".new_nav").each((function(e,a){let t=customMod(360-angle180to360(TRAILVIEWER._panViewer.getYaw())+$(a).data("yaw"),360);"viewer"==fullElement?$(a).css("transform","rotateZ("+t+"deg) translateY(-100px)"):$(a).css("transform","rotateZ("+t+"deg) translateY(-50px)")}));let e=(TRAILVIEWER._panViewer.getPitch()+90)/2.5;e>80?e=80:e<0&&(e=0),$("#nav_container").css("transform","perspective(300px) rotateX("+e+"deg)")}}function onNavArrowClicked(e){TRAILVIEWER.goToImageID(e)}function populateArrows(e){if(currentHotspots=e,$(".new_nav").remove(),e){for(let a=0;a<e.length;a++){let t=document.createElement("img");$(t).addClass("new_nav"),"viewer"==fullElement?($("#nav_container").removeClass("nav_container-small").addClass("nav_container-full"),$(t).addClass("new_nav-full")):($("#nav_container").removeClass("nav_container-full").addClass("nav_container-small"),$(t).addClass("new_nav-small")),$(t).attr("src","/static/images/ui/arrow_new_small_white.png"),$(t).data("yaw",e[a].yaw),$(t).data("id",e[a].clickHandlerArgs.id),$(t).hide(0),$(t).on("click",(function(e){e.preventDefault(),onNavArrowClicked($(this).data("id")),$(".new_nav").fadeOut(10)})),$(t).attr("draggable",!1),$("#nav_container").append($(t))}updateNavArrows(),$(".new_nav").fadeIn(200)}}function onGeoChange(e){currTrailViewGeo=e,null!=currentTrailViewMarker&&(currentTrailViewMarker.setLngLat([e.longitude,e.latitude]),MAP.easeTo({center:currentTrailViewMarker.getLngLat(),duration:500}))}function placeMarker(e,a,t){e.setLngLat([t,a]).addTo(MAP)}function clearMarker(e){e.remove()}function showInfoPopup(e,a){switch(a){case"warning":classes="info-popup warning";break;case"error":classes="info-popup error";break;default:classes="info-popup"}new mapboxgl.Popup({closeOnClick:!1,className:classes}).setLngLat(MAP.getCenter()).setHTML(e).addTo(MAP)}function changeBasemap(e){active_layer=STYLE_LAYERS[e],MAP.setStyle(active_layer,{diff:!1}),active_layer==STYLE_LAYER_CM_SAT?MAP.once("style.load",()=>{MAP.addSource("mapbox-dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1?optimize=true",tileSize:256,maxzoom:14}),MAP.setTerrain({source:"mapbox-dem",exaggeration:1.25}),updateTrailView()}):MAP.once("style.load",()=>{MAP.setTerrain(null),updateTrailView()})}function getBasemap(){return style=MAP.getStyle(),STYLE_NAMES[style.name]}function formatCoords(e,a){switch(format=null!=a?a:SETTINGS.coordinate_format,format){case"ddm":return formatCoordsDdm(e);case"dd":return formatCoordsDd(e);case"dms":default:return formatCoordsDms(e)}}function formatCoordsDms(e,a){a=void 0!==a?a:0;var t=e.lat<0?"S":"N",r=e.lng<0?"W":"E";lat_dd=Math.abs(e.lat),lng_dd=Math.abs(e.lng);var n=parseInt(lat_dd),i=parseInt(60*(lat_dd-n)),o=(3600*(lat_dd-n-i/60)).toFixed(a),l=parseInt(lng_dd),s=parseInt(60*(lng_dd-l)),c=(3600*(lng_dd-l-s/60)).toFixed(a);return coordsStr=n+"° "+i+"' "+o+'" '+t+", "+l+"° "+s+"' "+c+'" '+r,coordsStr}function formatCoordsDdm(e,a){a=void 0!==a?a:2;var t=e.lat<0?"S":"N",r=e.lng<0?"W":"E",n=Math.abs(e.lat),i=Math.abs(e.lng),o=parseInt(n),l=(60*(n-o)).toFixed(a),s=parseInt(i),c=(60*(i-s)).toFixed(a);return coordsStr=o+"° "+l+"' "+t+", "+s+"° "+c+"' "+r,coordsStr}function formatCoordsDd(e,a){return a=void 0!==a?a:4,coordsStr=e.lat.toFixed(a)+", "+e.lng.toFixed(a),coordsStr}function shortenStr(e,a,t){if(e.length<=a)return e;var r=e.substr(0,e.lastIndexOf(" ",a));return t&&(r+="..."),r}function saveWindowURL(e,a){WINDOW_URL=decodeURIComponent(location.pathname+"?"+e),WINDOW_URL_QUERYSTRING=e.toString(),a?window.history.pushState(null,null,WINDOW_URL):window.history.replaceState(null,null,WINDOW_URL)}function setWindowURLQueryStringParameters(e,a,t){var r;r=a?new URLSearchParams:new URLSearchParams(location.search),$.each(e,(function(e,a){r.set(e,a)})),saveWindowURL(r,t)}window.addEventListener("resize",onWindowResize);