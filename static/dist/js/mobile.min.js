var WINDOW_URL=null,WINDOW_URL_QUERYSTRING=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=mapboxgl.LngLat.convert(START_CENTER),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance";function createStartHereTooltip(){var e=$(".sidebar-tabs ul li:first")[0],t=$("body > div.ui-page")[0];return new Tooltip(e,{title:"Start exploring here!",container:t,placement:"right",trigger:"manual"})}function switchToMap(){sidebarCoversMap()&&sidebar.close()}function loadTrailViewStartingState(){let e=new URLSearchParams(location.search).get("view");if(!e||"null"==e)return $("#trailview_checkbox").prop("checked",!1).trigger("change").checkboxradio("refresh"),void updateTrailView();TRAILVIEWER?TRAILVIEWER.goToImageID(e):(initImageID=e,$("#trailview_checkbox").prop("checked",!0).trigger("change").checkboxradio("refresh")),updateTrailView()}function loadMapAndStartingState(){var e=new URLSearchParams(location.search),t=e.get("lat")||e.get("y"),a=e.get("lng")||e.get("x"),i=e.get("zoom")||e.get("z");if(mapOptions={base:e.get("base"),lat:t,lng:a,zoom:i,drop_marker:!1},MAP&&MAP.remove(),initMap(mapOptions),e.get("type")&&e.get("gid")){var n=e.get("type");switch(n){case"attraction":$(document).on("dataReadyAttractions",(function(){var t=e.get("gid"),a={};if((attraction=CM.get_attraction(t))&&(a.gid=attraction.gis_id,a.title=attraction.pagetitle,a.lat=attraction.latitude,a.lng=attraction.longitude),!a.lat||!a.lng)return alert("Cound not find that feature.");zoomToFeature(a),showFeatureInfo(n,a)}));break;case"reservation_new":$(document).on("dataReadyReservations",(function(){var t=e.get("gid"),a={type:"reservation_new"};if((reservation=CM.get_reservation(t))&&(a.gid=reservation.record_id,a.w=reservation.boxw,a.n=reservation.boxn,a.e=reservation.boxe,a.s=reservation.boxs,a.lat=reservation.latitude,a.lng=reservation.longitude),!(a.w&&a.n&&a.e&&a.s||a.lat&&a.lng))return alert("Cound not find that reservation.");zoomToFeature(a),showFeatureInfo(n,a)}));break;case"loop":$(document).on("dataReadyTrails",(function(){var t={type:"loop",gid:e.get("gid")};showFeatureInfo(n,t)}))}}if("directions"==e.get("action")){var o=e.get("via"),r=e.get("sourceText");r&&$("#source-input").val(r);var l=e.get("sourceLatLng").split(",")[0],s=e.get("sourceLatLng").split(",")[1],c=new mapboxgl.LngLat(s,l);setDirectionsInputLngLat($("#source-input"),c);var d=e.get("targetText");d&&$("#target-input").val(d);var g=e.get("targetLatLng").split(",")[0],u=e.get("targetLatLng").split(",")[1],p=new mapboxgl.LngLat(u,g);setDirectionsInputLngLat($("#target-input"),p),sidebar.open("pane-directions"),getDirections(c,p,o)}var m=e.get("base")||"map",h=$('input[name="basemap"][value="map"]'),f=$('input[name="basemap"][value="photo"]'),_=$('input[name="basemap"][value="terrain"]');h.prop("checked","map"==m).checkboxradio("refresh"),f.prop("checked","photo"==m).checkboxradio("refresh"),_.prop("checked","terrain"==m).checkboxradio("refresh"),$.event.trigger({type:"mapReady"})}function make_image_from_pagethumbnail(e,t){e=e.replace("~/","https://www.clevelandmetroparks.com/");var a=new URL(e),i=a.searchParams.get("width"),n=a.searchParams.get("height"),o=a.searchParams;return new_height=parseInt(n/(i/t)),o.set("width",2*t),o.set("height",2*new_height),{src:a.protocol+"//"+a.hostname+a.pathname+"?"+o.toString(),width:t,height:new_height}}function make_activity_icons_list(e){var t=[];return e.forEach((function(e){CM.activities[e]?t.push({src:CM.activities[e].icon,title:CM.activities[e].pagetitle,alt:CM.activities[e].pagetitle}):console.error("Error in make_activity_icons_list(): Activity "+e+" does not exist.")})),t}function showFeatureInfoContent(e,t){switch(e){case"attraction":var a=CM.get_attraction(t),i=CM.Templates.info_attraction,n=[];a.activities&&(n=make_activity_icons_list(a.activities));var o=[];if(a.pagethumbnail&&(o=make_image_from_pagethumbnail(a.pagethumbnail,320)),a.latitude&&a.longitude){var r=new mapboxgl.LngLat(a.longitude,a.latitude);a.coords_formatted=formatCoords(r)}if(a.cmp_url){var l=a.cmp_url;const e=/^\//;a.main_site_url=CM_SITE_BASEURL+l.replace(e,"")}var s={feature:a,activity_icons:n,img:o};$("#info-content").html(i(s));break;case"reservation_new":var c=CM.get_reservation(t);i=CM.Templates.info_reservation;c.pagethumbnail&&(o=make_image_from_pagethumbnail(c.pagethumbnail,320));s={feature:c,img:o};$("#info-content").html(i(s));break;case"loop":if(t in CM.trails){$.get(API_NEW_BASE_URL+"trail_geometries/"+t,null,(function(e){e.data.geom_geojson&&drawHighlightLine(JSON.parse(e.data.geom_geojson))})),$.get(API_NEW_BASE_URL+"trail_profiles/"+t,null,(function(e){e.data.elevation_profile&&makeElevationProfileChart(e.data.elevation_profile,"elevation-profile-trail")}));var d=CM.trails[t];i=CM.Templates.info_trail,s={feature:d,img_src:"static/images/loops/"+d.id+".jpg"};$("#info-content").html(i(s))}else console.error("Error: loop id: "+t+" does not exist in CM.trails (app_view_trails).")}}function makeElevationProfileChart(e,t){if(!e){if(!CM.elevationProfileData)return;e=CM.elevationProfileData}for(var a=[],i=0,n=e.length;i<n;i++)a.push({x:e[i].x/5280,y:e[i].y});t||(t="elevation-profile");var o=document.getElementById(t).getContext("2d");new Chart(o,{type:"line",data:{datasets:[{label:"Elevation Profile",data:a,pointRadius:0,backgroundColor:"rgba(0, 0, 0, 0.2)",borderColor:"rgba(0, 0, 0, 1)",borderWidth:2,fill:!1}]},options:{plugins:{legend:{display:!1}},responsive:!0,scales:{y:{title:{display:!0,text:"Elevation (feet)",color:"#000"}},x:{type:"linear",title:{display:!0,text:"Distance (miles)",color:"#000"},ticks:{min:0,precision:2}}}}})}function zoomElementClick(e){var t=getFeatureFromElement(e);showFeatureInfo(t.type,t),showOnMap(t)}function setUpDirectionsTarget(e){}function showFeatureInfo(e,t){$("#show_on_map").data("zoomelement",t),$("#show_on_map").data("wkt",null),setUpDirectionsTarget(t),sidebar.open("pane-info"),t.back_url||(t.back_url="#pane-browse"),set_pane_back_button("#pane-info",t.back_url),$("#info-content").text("Loading...");var a=t.gid||t.record_id;a&&showFeatureInfoContent(e,a)}function getFeatureFromElement(e){var t={};return t.title=e.attr("title"),t.w=e.attr("w"),t.s=e.attr("s"),t.e=e.attr("e"),t.n=e.attr("n"),t.lat=e.attr("lat"),t.lng=e.attr("lng"),t.type=e.attr("type"),"reservation_new"==t.type&&e.attr("record_id")?t.gid=e.attr("record_id"):t.gid=e.attr("gid"),t.back_url=e.attr("backbutton"),t}function getListDistances(e){(e||(e=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length)&&e.find(".zoom_distance").each((function(){var e=$(this).parent().parent(),t=new mapboxgl.LngLat(e.attr("lng"),e.attr("lat")),a=distanceTo(LAST_KNOWN_LOCATION,t),i=bearingToInNESW(LAST_KNOWN_LOCATION,t),n=3.2808399*a,o=n>900?(a/1609.344).toFixed(1)+" mi":n.toFixed(0)+" ft";o+=" "+i,$(this).text(o),e.data("meters",a)}))}function sortLists(e,t){if(e||(e=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(getListDistances(e),t||(t=DEFAULT_SORT),t){case"distance":e.children("li").sort((function(e,t){return $(e).data("meters")>$(t).data("meters")?1:-1}));break;case"alphabetical":e.children("li").sort((function(e,t){return $(e).text()>$(t).text()?1:-1}))}e.children("li.ui-first-child").removeClass("ui-first-child"),e.children("li").first().addClass("ui-first-child"),e.children("li.ui-last-child").removeClass("ui-last-child"),e.children("li").last().addClass("ui-last-child")}}function showWkt(e){drawHighlightLine(new Wkt.Wkt(e).toJson())}function drawHighlightLine(e){clearHighlightLine(),MAP.addLayer({id:"highlightLine",type:"line",source:{type:"geojson",data:e},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#01B3FD","line-width":6,"line-opacity":.75}})}function clearHighlightLine(){MAP.getLayer("highlightLine")&&MAP.removeLayer("highlightLine"),MAP.getSource("highlightLine")&&MAP.removeSource("highlightLine")}function zoomToAddress(e){if(!e)return!1;$.get(API_NEW_BASE_URL+"geocode/"+e,null,(function(e){if(!e.data)return alert("We couldn't find that address or city.\nPlease try again.");var t=new mapboxgl.LngLat(e.data.lng,e.data.lat);if(!MAX_BOUNDS.contains(t))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(),placeMarker(MARKER_TARGET,e.data.lat,e.data.lng),MAP.flyTo({center:t,zoom:DEFAULT_POI_ZOOM});var a='<h3 class="popup_title">'+e.data.title+"</h3>";a+='<span class="fakelink zoom" title="'+e.data.title+'" lat="'+e.data.lat+'" lng="'+e.data.lng+'" w="'+e.data.w+'" s="'+e.data.s+'" e="'+e.data.e+'" n="'+e.data.n+'" onClick="zoomElementClick($(this));">Directions</span>';(new mapboxgl.Popup).setLngLat(t).setHTML(a).addTo(MAP)}),"json")}function showOnMap(e,t){if(e.type&&e.gid&&0!=e.gid){var a={type:e.type,gid:e.gid};setWindowURLQueryStringParameters(a,!1,!0)}zoomToFeature(e,t)}function zoomToFeature(e,t){if(clearMarker(MARKER_TARGET),clearHighlightLine(),t&&switchToMap(),e.w&&e.s&&e.e&&e.n&&0!=e.w&&0!=e.s&&0!=e.e&&0!=e.n){var a=new mapboxgl.LngLat(e.w,e.s),i=new mapboxgl.LngLat(e.e,e.n),n=new mapboxgl.LngLatBounds(a,i);MAP.fitBounds(n,{padding:10})}else e.lng&&e.lat&&MAP.flyTo({center:[e.lng,e.lat],zoom:DEFAULT_POI_ZOOM});"poi"!=e.type&&"attraction"!=e.type&&"loop"!=e.type||placeMarker(MARKER_TARGET,e.lat,e.lng),e.wkt&&showWkt(e.wkt)}function setupWindowURLUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var e=MAP.getCenter(),t=e.lat.toFixed(7),a=e.lng.toFixed(7);invalidateWindowURL(),params={lat:t,lng:a},setWindowURLQueryStringParameters(params,!1,!1)}function updateWindowURLZoom(){var e=MAP.getZoom().toFixed(1);invalidateWindowURL(),setWindowURLQueryStringParameters({zoom:e},!1)}function updateWindowURLLayer(){invalidateWindowURL(),setWindowURLQueryStringParameters({base:currentMapLayer},!1,!1)}function invalidateWindowURL(){hideShareURL()}function changeCoordinateFormat(e){SETTINGS.coordinate_format=e,localStorage.setItem("coordinateFormat",e)}function getSessionCoordinateFormat(){var e=localStorage.getItem("coordinateFormat");"dms"!=e&&"ddm"!=e&&"dd"!=e||(SETTINGS.coordinate_format=e,$("#coordinate_format input[name=coordinate_format]").prop("checked",!1).checkboxradio("refresh"),$("#coordinate_format input[name=coordinate_format][value="+e+"]").prop("checked",!0).checkboxradio("refresh"),updateUserCoordsDisplay())}$(document).on("mapInitialized",(function(){if(sidebar||(sidebar=$("#sidebar").sidebar()),"/"!=window.location.pathname||""!=window.location.search||sidebarCoversMap()){var e=createStartHereTooltip();setTimeout(e.show,2500),setTimeout(e.dispose,15e3),$(document).click((function(){e.hide()}))}else sidebar.open("pane-welcome")})),$(document).ready((function(){loadMapAndStartingState(),populateSidebarPanes(),IS_TRAILVIEW_ENABLED&&fetchTrailViewData()})),window.onpopstate=function(){loadMapAndStartingState(),IS_TRAILVIEW_ENABLED&&loadTrailViewStartingState()},$(document).ready((function(){$('input[type="radio"][name="basemap"]').change((function(){var e=$(this).val();changeBasemap(e),updateWindowURLLayer(),sidebar.close()}))})),$(document).ready((function(){$("div.sortpicker span").click((function(){DEFAULT_SORT=$(this).attr("value"),sortLists()}))})),$(document).ready((function(){$(".zoom").click((function(){zoomElementClick($(this))}))})),$(document).ready((function(){$("#geocode_button").click((function(){zoomToAddress($("#geocode_text").val())})),$("#geocode_text").keydown((function(e){13==e.keyCode&&$("#geocode_button").click()}))})),$(document).ready((function(){$("#show_on_map").click((function(){var e=$(this).data("zoomelement");e&&(e.wkt=$(this).data("wkt"),showOnMap(e,!0))}))})),$(document).on("mapReady",setupWindowURLUpdates),$(document).ready((function(){$('input[type="radio"][name="coordinate_format"]').change((function(){changeCoordinateFormat($(this).val()),updateUserCoordsDisplay()}))})),$(document).ready((function(){getSessionCoordinateFormat()})),$(document).on("mapReady",(function(){MAP.on("mousemove",(function(e){var t=MAP.queryRenderedFeatures(e.point);document.getElementById("debug-features").innerHTML=JSON.stringify(t,null,2)}))}));